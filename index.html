<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Media Content Tracker</title>
<style>
:root {
  --bg:#f7f7f5; --surface:#fff; --surface2:#f1f0ee; --border:#e3e2de; --border2:#d5d4cf;
  --text:#1a1a18; --text2:#787774; --text3:#aeaca8; --accent:#2383e2;
  --shadow:0 1px 3px rgba(0,0,0,.08); --shadow-md:0 4px 20px rgba(0,0,0,.12);
  --product-bg:#e9e4f7; --product-fg:#5b3fa6;
  --money-bg:#d6eaf8;   --money-fg:#1a5d8f;
  --modern-bg:#fdf0c2;  --modern-fg:#8a6a00;
  --pda-bg:#e8e8e6;     --pda-fg:#4a4a48;
  --icp-bg:#fce7f3;     --icp-fg:#9d174d;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:-apple-system,'Inter','Segoe UI',sans-serif;min-height:100vh;}

/* PAGE HEADER */
.page-header{padding:44px 48px 16px;}
.page-title{font-size:2.2rem;font-weight:800;letter-spacing:-.5px;}
.collab-bar{display:flex;align-items:center;gap:10px;margin-top:10px;}
.collab-pill{font-size:.78rem;background:#e8f3fd;color:#2383e2;padding:4px 12px;border-radius:20px;border:1px solid #bdd8f7;font-weight:500;display:flex;align-items:center;gap:5px;}
.online-dot{width:7px;height:7px;background:#22c55e;border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:8px;padding:12px 48px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.tab{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:6px;font-size:.875rem;color:var(--text2);cursor:pointer;border:none;background:none;font-family:inherit;transition:background .15s;}
.tab:hover{background:var(--surface2);}
.tab.active{background:var(--surface2);color:var(--text);font-weight:500;}
.sep{width:1px;height:20px;background:var(--border2);flex-shrink:0;}
.toolbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.search-wrap{position:relative;}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:13px;pointer-events:none;}
.search-input{border:1px solid var(--border2);border-radius:6px;padding:6px 12px 6px 30px;font-size:.82rem;color:var(--text);background:var(--surface);outline:none;font-family:inherit;width:200px;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text3);}
.btn-new{background:var(--accent);color:white;border:none;border-radius:6px;padding:7px 16px;font-size:.875rem;font-weight:600;cursor:pointer;font-family:inherit;transition:background .15s;}
.btn-new:hover{background:#1a6fc4;}

/* FILTER BAR ‚Äî dropdowns */
.filter-bar{display:flex;align-items:center;gap:8px;padding:10px 48px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.filter-label-sm{font-size:.72rem;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.4px;}

/* DROPDOWN FILTER */
.dd-wrap{position:relative;}
.dd-trigger{display:flex;align-items:center;gap:6px;padding:5px 12px;border:1px solid var(--border2);border-radius:8px;background:var(--surface);color:var(--text2);font-size:.82rem;cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;font-weight:500;}
.dd-trigger:hover{border-color:var(--text3);color:var(--text);}
.dd-trigger.active{background:var(--text);color:white;border-color:var(--text);}
.dd-trigger .arrow{font-size:10px;opacity:.6;}
.dd-menu{position:absolute;top:calc(100% + 6px);left:0;background:var(--surface);border:1px solid var(--border2);border-radius:10px;box-shadow:var(--shadow-md);padding:6px;min-width:180px;z-index:150;display:none;flex-direction:column;gap:2px;}
.dd-menu.open{display:flex;}
.dd-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:6px;cursor:pointer;font-size:.84rem;color:var(--text);transition:background .12s;}
.dd-item:hover{background:var(--surface2);}
.dd-item .check{width:16px;height:16px;border:1.5px solid var(--border2);border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;}
.dd-item.checked .check{background:var(--accent);border-color:var(--accent);color:white;}
.dd-divider{height:1px;background:var(--border);margin:4px 0;}
.dd-clear{font-size:.78rem;color:#e03e3e;padding:5px 10px;cursor:pointer;border-radius:6px;}
.dd-clear:hover{background:#fff5f5;}
.active-count{background:var(--accent);color:white;border-radius:20px;padding:0 6px;font-size:.7rem;font-weight:700;}
.clear-all-btn{font-size:.78rem;color:#e03e3e;cursor:pointer;background:none;border:none;font-family:inherit;font-weight:600;padding:4px 8px;border-radius:6px;}
.clear-all-btn:hover{background:#fff5f5;}

/* BOARD */
.board{display:flex;padding:20px 48px 60px;overflow-x:auto;align-items:flex-start;gap:14px;}
.col{min-width:272px;width:272px;flex-shrink:0;}
.col-header{display:flex;align-items:center;gap:8px;padding:2px 2px 12px;}
.col-badge{font-size:.82rem;font-weight:600;padding:4px 14px;border-radius:20px;flex:1;}
.col-count{font-size:.75rem;color:var(--text3);}
.col-addbtn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:17px;padding:0 4px;border-radius:4px;line-height:1;}
.col-addbtn:hover{background:var(--surface2);color:var(--text2);}
.cards{display:flex;flex-direction:column;gap:8px;min-height:60px;border-radius:8px;transition:background .15s;padding:2px;}
.cards.drag-over{background:rgba(35,131,226,.07);outline:2px dashed rgba(35,131,226,.3);}

/* CARD (board) */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px 14px 11px;cursor:pointer;transition:box-shadow .15s,border-color .15s,opacity .15s;box-shadow:var(--shadow);user-select:none;}
.card:hover{box-shadow:var(--shadow-md);border-color:var(--border2);}
.card.dragging{opacity:.4;cursor:grabbing;}
.card-grab{color:var(--text3);font-size:11px;cursor:grab;margin-top:1px;flex-shrink:0;}
.card-top{display:flex;align-items:flex-start;gap:7px;margin-bottom:9px;}
.card-title-text{font-size:.875rem;font-weight:500;line-height:1.45;}
.card-tags{display:flex;flex-wrap:wrap;gap:4px;}
.tag{font-size:.72rem;padding:2px 9px;border-radius:5px;font-weight:500;}
.card-footer{display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap;}
.cmeta{font-size:.71rem;color:var(--text3);}
.add-card-btn{display:flex;align-items:center;gap:5px;padding:7px 4px;border:none;background:none;color:var(--text3);font-size:.84rem;cursor:pointer;border-radius:6px;width:100%;font-family:inherit;margin-top:4px;transition:all .12s;}
.add-card-btn:hover{color:var(--text2);background:var(--surface2);}

/* STATUS COLORS */
.s-backlog{background:#dbeafe;color:#1d4ed8;}
.s-prioritize{background:#e5e7eb;color:#374151;}
.s-designfb{background:#fef9c3;color:#854d0e;}
.s-scheduled{background:#fed7aa;color:#9a3412;}
.s-published{background:#dcfce7;color:#166534;}
.s-archived{background:#ede9fe;color:#5b21b6;}
/* TAG COLORS */
.t-product{background:var(--product-bg);color:var(--product-fg);}
.t-money{background:var(--money-bg);color:var(--money-fg);}
.t-modern{background:var(--modern-bg);color:var(--modern-fg);}
.t-pda{background:var(--pda-bg);color:var(--pda-fg);}
.t-sr-product{background:#ede9fa;color:var(--product-fg);}
.t-sr-money{background:#daeef8;color:var(--money-fg);}
.t-sr-modern{background:#fef3cc;color:var(--modern-fg);}
.t-plat{background:#f1f5f9;color:#475569;}
.t-who{background:#f3f0ff;color:#5b3fa6;}
.t-icp{background:var(--icp-bg);color:var(--icp-fg);}
.t-channel{background:#ecfdf5;color:#065f46;}
.t-posttype{background:#fff7ed;color:#9a3412;}

/* ‚îÄ‚îÄ DETAIL PANEL (Notion-style) ‚îÄ‚îÄ */
.detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:300;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;backdrop-filter:blur(2px);overflow-y:auto;}
.detail-panel{background:var(--surface);border-radius:14px;width:100%;max-width:740px;box-shadow:0 24px 80px rgba(0,0,0,.2);position:relative;}
.detail-icon-area{padding:32px 48px 0;font-size:48px;line-height:1;}
.detail-title-area{padding:12px 48px 0;}
.detail-title{font-size:1.9rem;font-weight:800;letter-spacing:-.5px;border:none;outline:none;width:100%;font-family:inherit;color:var(--text);background:transparent;line-height:1.2;}
.detail-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text3);font-size:18px;cursor:pointer;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;}
.detail-close:hover{background:var(--surface2);}

/* PROPERTIES TABLE */
.detail-props{padding:20px 48px 0;display:flex;flex-direction:column;gap:2px;}
.prop-row{display:grid;grid-template-columns:160px 1fr;align-items:start;padding:5px 0;border-radius:6px;transition:background .12s;}
.prop-row:hover{background:var(--surface2);}
.prop-label{display:flex;align-items:center;gap:7px;font-size:.84rem;color:var(--text2);padding:4px 8px 4px 0;}
.prop-label-icon{font-size:13px;}
.prop-value{display:flex;align-items:center;flex-wrap:wrap;gap:5px;padding:4px 8px;min-height:30px;font-size:.84rem;color:var(--text);cursor:pointer;border-radius:6px;}
.prop-value:hover{background:#ebebea;}
.prop-value.empty{color:var(--text3);}
.prop-select-wrap{position:relative;flex:1;}

/* DETAIL CONTENT */
.detail-body{padding:24px 48px 40px;display:flex;flex-direction:column;gap:20px;}
.section-block{display:flex;flex-direction:column;gap:8px;}
.section-heading{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);display:flex;align-items:center;gap:6px;}
.section-textarea{border:none;outline:none;width:100%;font-family:inherit;font-size:.9rem;color:var(--text);background:transparent;resize:none;line-height:1.6;min-height:40px;height:auto;overflow:hidden;}
.section-textarea::placeholder{color:var(--text3);}
.section-textarea:focus{background:var(--surface2);border-radius:6px;padding:6px 8px;}
.rich-toolbar{display:flex;align-items:center;gap:2px;padding:4px 6px;background:var(--surface2);border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;flex-wrap:wrap;}
.rich-btn{background:none;border:none;padding:4px 8px;border-radius:5px;cursor:pointer;font-size:.8rem;color:var(--text2);font-family:inherit;transition:background .12s;line-height:1;}
.rich-btn:hover{background:var(--border2);color:var(--text);}
.rich-sep{width:1px;height:16px;background:var(--border2);margin:0 2px;flex-shrink:0;}
.rich-editor{border:1px solid var(--border);border-radius:0 0 8px 8px;padding:10px 12px;min-height:80px;outline:none;font-family:inherit;font-size:.9rem;color:var(--text);line-height:1.6;background:white;}
.rich-editor:focus{border-color:var(--accent);}
.rich-editor a{color:var(--accent);text-decoration:underline;word-break:break-all;}
.rich-editor table{border-collapse:collapse;width:100%;margin:8px 0;font-size:.85rem;}
.rich-editor table td,.rich-editor table th{border:1px solid var(--border2);padding:7px 10px;text-align:left;vertical-align:top;}
.rich-editor table th{background:var(--surface2);font-weight:600;}
.rich-editor ul,.rich-editor ol{padding-left:20px;margin:4px 0;}
.rich-editor p{margin:0 0 4px;}
.rich-editor:empty:before{content:attr(data-placeholder);color:var(--text3);pointer-events:none;}

/* SLIDES */
.slides-list{display:flex;flex-direction:column;gap:10px;}
.slide-item{background:var(--surface2);border-radius:10px;padding:14px 16px;border:1px solid var(--border);}
.slide-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.slide-num{font-size:.78rem;font-weight:700;color:var(--accent);}
.slide-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;border-radius:4px;padding:2px 6px;}
.slide-del:hover{background:var(--border);color:#e03e3e;}
.slide-input{border:none;outline:none;font-family:inherit;font-size:.88rem;font-weight:600;color:var(--text);background:transparent;width:100%;margin-bottom:4px;}
.slide-input::placeholder{color:var(--text3);}
.slide-body{border:none;outline:none;font-family:inherit;font-size:.84rem;color:var(--text2);background:transparent;width:100%;resize:none;min-height:40px;line-height:1.5;}
.slide-body::placeholder{color:var(--text3);}
.slide-body:focus,.slide-input:focus{background:white;border-radius:4px;padding:2px 6px;}
.add-slide-btn{display:flex;align-items:center;gap:6px;padding:8px 12px;border:1px dashed var(--border2);background:none;border-radius:8px;color:var(--text3);font-size:.84rem;cursor:pointer;font-family:inherit;transition:all .15s;width:100%;}
.add-slide-btn:hover{border-color:var(--accent);color:var(--accent);}

/* IMAGE REFERENCES */
.img-refs{display:flex;flex-wrap:wrap;gap:10px;}
.img-ref-item{position:relative;width:90px;height:90px;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:var(--surface2);}
.img-ref-item img{width:100%;height:100%;object-fit:cover;}
.img-ref-del{position:absolute;top:3px;right:3px;background:rgba(0,0,0,.55);border:none;color:white;border-radius:4px;width:20px;height:20px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;}
.img-ref-del:hover{background:rgba(200,0,0,.8);}
.img-upload-btn{width:90px;height:90px;border:2px dashed var(--border2);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:var(--text3);font-size:.72rem;gap:4px;transition:all .15s;background:none;}
.img-upload-btn:hover{border-color:var(--accent);color:var(--accent);}
.img-upload-btn svg{width:20px;height:20px;}
#imgFileInput{display:none;}

/* PROP INLINE PICKERS */
.inline-picker{position:absolute;top:calc(100% + 4px);left:0;background:var(--surface);border:1px solid var(--border2);border-radius:10px;box-shadow:var(--shadow-md);padding:6px;min-width:200px;z-index:400;display:flex;flex-direction:column;gap:2px;}
.ip-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:6px;cursor:pointer;font-size:.84rem;transition:background .12s;}
.ip-item:hover{background:var(--surface2);}
.ip-check{width:16px;height:16px;border:1.5px solid var(--border2);border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:10px;}
.ip-item.on .ip-check{background:var(--accent);border-color:var(--accent);color:white;}

/* DETAIL FOOTER */
.detail-footer{padding:14px 48px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;align-items:center;}
.btn{border:none;border-radius:8px;padding:8px 18px;font-size:.875rem;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit;}
.btn-primary{background:var(--text);color:white;}
.btn-primary:hover{background:#333;}
.btn-ghost{background:none;color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--surface2);}
.btn-del{background:none;color:#e03e3e;border:none;font-size:.82rem;margin-right:auto;}
.btn-del:hover{text-decoration:underline;}

/* IMPORT MODAL */
.import-modal{background:var(--surface);border-radius:14px;width:100%;max-width:480px;box-shadow:0 24px 80px rgba(0,0,0,.2);padding:28px 32px;display:flex;flex-direction:column;gap:16px;}
.import-modal h2{font-size:1.1rem;font-weight:700;}
.import-zone{border:2px dashed var(--border2);border-radius:10px;padding:32px;text-align:center;cursor:pointer;color:var(--text2);font-size:.88rem;transition:all .15s;}
.import-zone:hover{border-color:var(--accent);color:var(--accent);}
#csvFileInput{display:none;}

.hidden{display:none!important;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--text);color:white;border-radius:8px;padding:10px 20px;font-size:.84rem;z-index:999;white-space:nowrap;box-shadow:var(--shadow-md);animation:fadeUp .2s ease;}
@keyframes fadeUp{from{opacity:0;transform:translate(-50%,8px)}to{opacity:1;transform:translate(-50%,0)}}
.loading{display:flex;align-items:center;justify-content:center;padding:100px;gap:10px;color:var(--text2);}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
@media(max-width:640px){
  .page-header,.toolbar,.filter-bar,.board,.detail-props,.detail-body,.detail-icon-area,.detail-title-area,.detail-footer{padding-left:16px;padding-right:16px;}
  .page-title{font-size:1.5rem;}
  .prop-row{grid-template-columns:120px 1fr;}
}
</style>
</head>
<body>
<div id="root"><div class="loading"><div class="spinner"></div> Cargando‚Ä¶</div></div>
<div id="detailOverlay" class="detail-overlay hidden" onclick="detailBgClose(event)"></div>
<div id="importOverlay" class="detail-overlay hidden" onclick="importBgClose(event)">
  <div class="import-modal">
    <h2>üì• Importar desde Notion (CSV)</h2>
    <p style="font-size:.84rem;color:var(--text2);line-height:1.5">Exporta tu base de datos desde Notion como <strong>CSV</strong> y sube el archivo aqu√≠. Mapearemos autom√°ticamente las columnas que coincidan.</p>
    <div class="import-zone" onclick="document.getElementById('csvFileInput').click()">
      <div style="font-size:28px;margin-bottom:8px">üìÑ</div>
      Haz clic para seleccionar tu CSV de Notion<br>
      <span style="font-size:.76rem;color:var(--text3);margin-top:4px;display:block">o arrastra y su√©ltalo aqu√≠</span>
    </div>
    <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSV(event)">
    <div id="importPreview" class="hidden" style="font-size:.84rem;color:var(--text2);"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeImport()">Cancelar</button>
      <button class="btn btn-primary hidden" id="btnImportConfirm" onclick="confirmImport()">Importar</button>
    </div>
  </div>
</div>
<input type="file" id="imgFileInput" accept="image/*" multiple onchange="handleImgUpload(event)">

<script>
// ‚îÄ‚îÄ‚îÄ TAXONOMY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STATUS = {
  backlog:    {label:'Backlog',         cls:'s-backlog',    order:0},
  prioritize: {label:'üî• Prioritize',   cls:'s-prioritize', order:1},
  designfb:   {label:'Design feedback', cls:'s-designfb',   order:2},
  scheduled:  {label:'Scheduled',       cls:'s-scheduled',  order:3},
  published:  {label:'Published',       cls:'s-published',  order:4},
  archived:   {label:'Archived',        cls:'s-archived',   order:5},
};
const CHANNELS    = ['Instagram','TikTok','Twitter/X','YouTube','LinkedIn','Facebook','Newsletter'];
const POST_TYPES  = ['Carousel','Reel','Story','Static','Thread','Video','Email'];
const WHO_LIST    = ['Distrito','SM Team','Creative Studio','Val'];
const ICP_LIST    = ['Affluent','HNWI'];
const PILAR_LIST  = ['Product','Money talks','Modern investor','PdA'];
const PILAR_SERIES = {
  'Product':         ['Guides','Value prop','Safety'],
  'Money talks':     ['Pop culture','Lifestyle'],
  'Modern investor': ['Strategies','Market analysis','Mindset'],
  'PdA':             [],
};
const PILAR_TAG_CLS  = {'Product':'t-product','Money talks':'t-money','Modern investor':'t-modern','PdA':'t-pda'};
const SERIE_TAG_CLS  = {
  'Guides':'t-sr-product','Value prop':'t-sr-product','Safety':'t-sr-product',
  'Pop culture':'t-sr-money','Lifestyle':'t-sr-money',
  'Strategies':'t-sr-modern','Market analysis':'t-sr-modern','Mindset':'t-sr-modern',
};
const PLAT_ICONS = {Instagram:'üì∏',TikTok:'üéµ','Twitter/X':'üê¶',YouTube:'‚ñ∂Ô∏è',LinkedIn:'üíº',Facebook:'üìò',Newsletter:'üìß'};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cards = [];
let searchQ = '';
let AF = {channel:[], who:[], pilar:[], serie:[]};
let dragId = null;
let sortBy = 'default';
let saveTimer;
let lastSaveTime = 0;
let currentDetailId = null;
let pendingImport = [];
let openDropdown = null;

const SEED = [{"id": "s1", "title": "Digital Gold (XAUT & PAXG)", "status": "published", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Strategies"], "icp": ["Affluent"], "date": "Feb 10", "brief": "Invertir como los abuelos", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 1}, {"id": "s2", "title": "Feriado XXL - AR", "status": "published", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Product"], "serie": ["Value prop"], "icp": ["Affluent"], "date": "Feb 10", "brief": "Trade 24/7", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 2}, {"id": "s3", "title": "Invest as a Bonsai", "status": "published", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Mindset"], "icp": ["Affluent"], "date": "Feb 10", "brief": "La riqueza no es un edificio que se construye; es un ser vivo que se cultiva.", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 3}, {"id": "s4", "title": "Superbowl", "status": "published", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Pop culture"], "icp": ["Affluent"], "date": "Feb 10", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "https://drive.google.com/drive/folders/1X2PYII0t10cj-61AKOQmR4zSQqIlMwLE", "createdAt": 4}, {"id": "s5", "title": "San Valentin", "status": "published", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Product"], "serie": ["Value prop"], "icp": ["Affluent"], "date": "Feb 10", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "https://drive.google.com/drive/folders/1xtR2wt-DHfL577HBJ6EgZC47_jR1lDcE", "createdAt": 5}, {"id": "s6", "title": "DCA en Bitso", "status": "designfb", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Product"], "serie": ["Guides"], "icp": ["Affluent"], "date": "Feb 16", "brief": "Captura de pantalla", "slides": [], "refs": [], "copyOut": "", "notes": "https://drive.google.com/drive/folders/1N1Yhsl_6TXfRNDkPvQuJJIqCRaSPQamf?usp=sharing", "url": "", "createdAt": 6}, {"id": "s7", "title": "Invertir la quincena", "status": "designfb", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Product"], "serie": ["Value prop"], "icp": ["Affluent", "HNWI"], "date": "Feb 10", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "https://drive.google.com/drive/folders/11HTPB4P-FfJ6-_mcQF0jscV5y0lxzYvS?usp=drive_link", "url": "", "createdAt": 7}, {"id": "s8", "title": "Evoluci√≥n del S&P", "status": "designfb", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Mindset"], "icp": ["HNWI"], "date": "Feb 18", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 8}, {"id": "s9", "title": "F1 - Money Talks", "status": "designfb", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Pop culture"], "icp": ["Affluent"], "date": "Feb 18", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 9}, {"id": "s10", "title": "Cartas P√≥kemon", "status": "published", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Pop culture"], "icp": ["Affluent"], "date": "Feb 26", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 10}, {"id": "s11", "title": "Oscars", "status": "designfb", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Pop culture"], "icp": ["Affluent"], "date": "Mar 11", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 11}, {"id": "s12", "title": "Minimos historicos", "status": "archived", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Mindset"], "icp": ["Affluent"], "date": "Feb 11", "brief": "https://www.instagram.com/p/DO_iS2IDfBe/", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 12}, {"id": "s13", "title": "Rebalancea como una playlist", "status": "prioritize", "channels": [], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Strategies"], "icp": [], "date": "Feb 11", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 13}, {"id": "s14", "title": "PdA: The \"Leaked\" Script", "status": "archived", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["PdA"], "serie": [], "icp": ["Affluent"], "date": "Feb 11", "brief": "https://www.google.com/search?sca_esv=59623aa993e8ccae&udm=2&fbs=ADc_l-aN0CWEZBOHjofHoaMMDiKpaEWjvZ2Py1XXV8d8KvlI3vWUtYx0DZdicpfE1faGYemg2KC4yuMPyQlIvlWqq2At2yMvCZgi_bwXXU0sv2NZz-do-7reUzJedhGnIXhKGuUFyoXjhqCzaayGmBsnSNjybdoBFcfZIo4O3r11dfjsX9noz133K6nvAb6AlSigrJGaSkHGzBju-O7lsi27eOFNhvv6ug&q=scripts+de+peliculas&sa=X&ved=2ahUKEwi0iO2975qSAxVmCLkGHa43FCgQtKgLegQIGRAB&biw=1710&bih=947&dpr=2&aic=0#sv=CAMSWBoyKhBlLUs5aWxrcWU2OW5UZWhNMg5LOWlsa3FlNjluVGVoTToOOHNMSmtTNGVqOUdibk0gBCocCgZtb3NhaWMSEGUtSzlpbGtxZTY5blRlaE0YADABOAAYByD6hvyfCDACOgBKCggCEAIYAiACKAI", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 14}, {"id": "s15", "title": "PdA: Countdown Stories", "status": "designfb", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["PdA"], "serie": [], "icp": [], "date": "Mar 6", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 15}, {"id": "s16", "title": "Safety content", "status": "backlog", "channels": ["Instagram", "TikTok", "Twitter/X"], "postType": [], "who": ["Creative Studio"], "pilar": ["Product"], "serie": ["Safety"], "icp": ["Affluent", "HNWI"], "date": "Feb 27", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 16}, {"id": "s17", "title": "Short video: Let's do something impossible", "status": "prioritize", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Val"], "pilar": ["PdA"], "serie": [], "icp": ["Affluent"], "date": "Feb 23", "brief": "https://www.instagram.com/p/DTynoIoDnv2/", "slides": [], "refs": [], "copyOut": "", "notes": "https://drive.google.com/drive/folders/1gR9-U5QTUO1NSrYogzspKaqGKchY5xQC?usp=sharing", "url": "https://drive.google.com/drive/folders/1IE04YKONRlBQ6eo5q8lI3cLudQT81-xC?usp=sharing", "createdAt": 17}, {"id": "s18", "title": "POV: Stunt Double Life", "status": "prioritize", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Val"], "pilar": ["PdA"], "serie": [], "icp": ["Affluent"], "date": "Feb 23", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "https://docs.google.com/document/d/1gc1Z-iVbC7xrcu4HYnrRAQAnIqVb83uqnbhCbCELqNI/edit?usp=sharing", "url": "https://drive.google.com/drive/folders/1DsmixJ_vNrjnveoKodGAiXmPJx0IXZXF?usp=sharing", "createdAt": 18}, {"id": "s19", "title": "Meme: \"Wanna be Eiza\" waiting in the Uber", "status": "prioritize", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Val"], "pilar": ["PdA"], "serie": [], "icp": [], "date": "Feb 23", "brief": "https://www.instagram.com/reel/DUQ3-SYj6Z8/?igsh=MXJsamxvdGF2ZHAyMw==", "slides": [], "refs": [], "copyOut": "", "notes": "https://docs.google.com/document/d/1TqTOuoG_N5gybScOvAS9lbqbL8dEh9xWTTLqYleJs7I/edit?usp=sharing", "url": "https://drive.google.com/drive/folders/10gZ-bouORnF6PWguofoZUXbgeyGP3Ix2?usp=sharing", "createdAt": 19}, {"id": "s20", "title": "Casting call", "status": "prioritize", "channels": ["Instagram", "TikTok", "Twitter/X"], "postType": [], "who": ["Val"], "pilar": ["PdA"], "serie": [], "icp": [], "date": "Feb 23", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "https://docs.google.com/document/d/1mf48WcGFjA4vbFM6iCBV_9oqZ9fG6stHxm2ZTQ5pP8o/edit?usp=sharing", "url": "https://drive.google.com/drive/folders/13wVAfdAW1-cqcZ1Iprngn3OYQgrbXRdO?usp=sharing", "createdAt": 20}, {"id": "s21", "title": "Mag 7", "status": "designfb", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Market analysis"], "icp": ["Affluent", "HNWI"], "date": "Feb 19", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 21}, {"id": "s22", "title": "Which Guineapig are you?", "status": "prioritize", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Val"], "pilar": ["PdA"], "serie": [], "icp": [], "date": "Feb 23", "brief": "https://www.tiktok.com/@isabellelizcano/video/7512131280213921080?_r=1&_t=ZS-93GF3XfFpGm", "slides": [], "refs": [], "copyOut": "", "notes": "https://docs.google.com/document/d/1p6jCD621LSZs5cIEEskTlH_EWcxOMyvcrnr0BVEeMHc/edit?usp=sharing", "url": "https://drive.google.com/drive/folders/1KsLqhENPtnl2_r4WrXozDAb6hL_TjjE8?usp=sharing", "createdAt": 22}, {"id": "s23", "title": "Realizar ganancias", "status": "prioritize", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Strategies"], "icp": ["Affluent", "HNWI"], "date": "Mar 4", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 23}, {"id": "s24", "title": "Entender los detalles de una acci√≥n", "status": "prioritize", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Product"], "serie": ["Guides"], "icp": ["Affluent", "HNWI"], "date": "Mar 24", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "https://support.bitso.com/hc/es-mx/articles/41793383787796-Entender-los-detalles-de-una-acci%C3%B3n-precios-gr%C3%A1ficos-estad%C3%ADsticas-y-desempe%C3%B1o", "createdAt": 24}, {"id": "s25", "title": "Dividendos", "status": "backlog", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Product"], "serie": ["Value prop"], "icp": ["Affluent", "HNWI"], "date": "Mar 31", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "https://support.bitso.com/hc/es-mx/articles/41793679229972-Dividendos-Qu%C3%A9-son-c%C3%B3mo-se-pagan-y-c%C3%B3mo-recibirlos", "createdAt": 25}, {"id": "s26", "title": "Starbucks", "status": "backlog", "channels": ["Instagram"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Lifestyle"], "icp": ["HNWI"], "date": "Feb 25", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 26}, {"id": "s27", "title": "Investor starter pack", "status": "published", "channels": ["Instagram"], "postType": [], "who": ["SM Team"], "pilar": ["Money talks"], "serie": ["Lifestyle"], "icp": ["HNWI"], "date": "Feb 18", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "https://drive.google.com/drive/folders/19IxU0LmNJzQGp4QX28JVUC2fqpOZCpWX?usp=sharing", "createdAt": 27}, {"id": "s28", "title": "Market cap vs.", "status": "backlog", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Market analysis"], "icp": ["Affluent", "HNWI"], "date": "Mar 4", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 28}, {"id": "s29", "title": "Giveaway", "status": "designfb", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": [], "pilar": ["Product"], "serie": [], "icp": [], "date": "Feb 18", "brief": "https://www.instagram.com/p/DT3F704Eb0T/?img_index=1", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 29}, {"id": "s30", "title": "Pa√≠ses que holdean BTC", "status": "backlog", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Market analysis"], "icp": ["Affluent", "HNWI"], "date": "Mar 11", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 30}, {"id": "s31", "title": "Pa√≠ses con reservas de oro", "status": "backlog", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Market analysis"], "icp": ["Affluent", "HNWI"], "date": "Mar 11", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 31}, {"id": "s32", "title": "Mundial: el nuevo lujo", "status": "backlog", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Pop culture"], "icp": ["Affluent"], "date": "Feb 18", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 32}, {"id": "s33", "title": "Treatenomics", "status": "backlog", "channels": ["Instagram", "TikTok", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Lifestyle"], "icp": ["Affluent", "HNWI"], "date": "Feb 18", "brief": "https://www.cnbc.com/2025/08/09/from-lipsticks-to-concerts-the-treatonomics-trend-is-booming.html", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 33}, {"id": "s34", "title": "Market an√°lisis", "status": "backlog", "channels": ["Instagram", "Twitter/X"], "postType": [], "who": ["Distrito"], "pilar": ["Modern investor"], "serie": ["Market analysis"], "icp": ["HNWI"], "date": "Feb 26", "brief": "INTERNAL: https://bitso.slack.com/archives/C0A811NC9KM/p1771507909360769?thread_ts=1771438604.992739&cid=C0A811NC9KM", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 34}, {"id": "s35", "title": "Vive Latino 2026", "status": "backlog", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Distrito"], "pilar": ["Money talks"], "serie": ["Pop culture"], "icp": ["Affluent", "HNWI"], "date": "Mar 11", "brief": "", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 35}, {"id": "s36", "title": "Hola, soy tu cerebro/ soy tu estomago", "status": "designfb", "channels": ["Instagram", "TikTok"], "postType": [], "who": ["Val"], "pilar": ["Money talks"], "serie": ["Lifestyle"], "icp": ["Affluent"], "date": "Mar 18", "brief": "https://www.instagram.com/p/DTsh8AREYtU/", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 36}, {"id": "s37", "title": "ASMR financiero", "status": "designfb", "channels": ["Instagram", "TikTok", "Twitter/X"], "postType": [], "who": ["Val"], "pilar": ["Modern investor"], "serie": ["Mindset"], "icp": ["Affluent", "HNWI"], "date": "Mar 18", "brief": "https://www.tiktok.com/@matdilisio/video/7360696530484858144?q=ASMR%20tech&t=1771534620606", "slides": [], "refs": [], "copyOut": "", "notes": "", "url": "", "createdAt": 37}, {"id": "s38", "title": "Red/green chill dog", "status": "backlog", "channels": ["TikTok", "Twitter/X"], "postType": [], "who": ["SM Team"], "pilar": ["Modern investor"], "serie": ["Mindset"], "icp": ["Affluent", "HNWI"], "date": "Feb 27", "brief": "https://x.com/alifarhat79/status/2024554318477529313", "slides": [], "refs": [], "copyOut": "", "notes": "https://tenor.com/es-419/view/shiba-shiba-dancing-shiba-dancing-music-dog-music-dog-dancing-gif-16848691", "url": "", "createdAt": 38}];

// ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = 'https://script.google.com/a/macros/bitso.com/s/AKfycbwop8vHqrwP6yoopDdMoVKl1ff6gtNLbF9tVPMeomXp3vgn5YLeiblvCEB7z4ijH__miA/exec';

async function load() {
  try {
    const r = await fetch(API, {method:'GET', redirect:'follow'});
    const data = await r.json();
    if (data.cards && Array.isArray(data.cards) && data.cards.length > 0) {
      cards = data.cards;
      return;
    }
    // First time ‚Äî seed with CSV data
    cards = SEED;
    await persist();
  } catch(e) {
    console.warn('Load error:', e);
    if (!cards.length) cards = SEED;
  }
}

async function persist() {
  try {
    await fetch(API, {
      method: 'POST',
      redirect: 'follow',
      headers: {'Content-Type': 'text/plain'},
      body: JSON.stringify({ action: 'save', cards })
    });
    lastSaveTime = Date.now();
    // Also save locally as backup
    try { localStorage.setItem('smct_backup', JSON.stringify(cards)); } catch(e) {}
  } catch(e) {
    console.warn('Save error:', e);
    // Retry once after 2 seconds
    setTimeout(persist, 2000);
  }
}

function qSave() { clearTimeout(saveTimer); saveTimer=setTimeout(persist,600); }

// ‚îÄ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseDate(d){
  if(!d) return null;
  const months={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const m=d.match(/([A-Za-z]+)\s+(\d+)/);
  if(m) return new Date(2026, months[m[1]]||0, parseInt(m[2]));
  const iso=new Date(d); return isNaN(iso)?null:iso;
}
function setSort(v){sortBy=v;render();}
function visible() {
  let list = [...cards];
  if(searchQ){const q=searchQ.toLowerCase();list=list.filter(c=>c.title.toLowerCase().includes(q)||(c.brief||'').toLowerCase().includes(q));}
  if(AF.channel.length) list=list.filter(c=>AF.channel.some(ch=>(c.channels||[]).includes(ch)));
  if(AF.who.length)     list=list.filter(c=>AF.who.some(w=>(c.who||[]).includes(w)));
  if(AF.pilar.length)   list=list.filter(c=>AF.pilar.some(p=>(c.pilar||[]).includes(p)));
  if(AF.serie.length)   list=list.filter(c=>AF.serie.some(s=>(c.serie||[]).includes(s)));
  if(sortBy==='date_asc')  list.sort((a,b)=>{const da=parseDate(a.date),db=parseDate(b.date);if(!da&&!db)return 0;if(!da)return 1;if(!db)return -1;return da-db;});
  if(sortBy==='date_desc') list.sort((a,b)=>{const da=parseDate(a.date),db=parseDate(b.date);if(!da&&!db)return 0;if(!da)return 1;if(!db)return -1;return db-da;});
  return list;
}

// ‚îÄ‚îÄ‚îÄ RENDER BOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const vis = visible();
  const hasF = Object.values(AF).some(a=>a.length)||searchQ;
  const allSeries = Object.values(PILAR_SERIES).flat();

  document.getElementById('root').innerHTML = `
    <div class="page-header">
      <div class="page-title">Social Media Content Tracker</div>
      <div class="collab-bar">
        <span class="collab-pill"><span class="online-dot"></span> Tablero compartido ¬∑ ${cards.length} piezas</span>
      </div>
    </div>
    <div class="toolbar">
      <button class="tab active">‚äû Content Pipeline</button>
      <div class="sep"></div>
      <button class="tab" onclick="toast('üìÖ Pr√≥ximamente')">üìÖ Calendar</button>
      <div class="toolbar-right">
        <div class="search-wrap"><span class="search-icon">üîç</span>
          <input class="search-input" placeholder="Buscar..." value="${eA(searchQ)}" oninput="setQ(this.value)">
        </div>
        <button class="btn btn-ghost" style="font-size:.82rem;padding:6px 12px" onclick="exportCSV()">üì§ Exportar CSV</button>
        <button class="btn btn-ghost" style="font-size:.82rem;padding:6px 12px" onclick="openImport()">üì• Importar CSV</button>
        <button class="btn-new" onclick="openDetail(null)">+ New</button>
      </div>
    </div>
    <div class="filter-bar">
      ${ddFilter('channel','Canal',CHANNELS,AF.channel,'channel')}
      ${ddFilter('who','Quien produce',WHO_LIST,AF.who,'who')}
      ${ddFilter('pilar','Pilar',PILAR_LIST,AF.pilar,'pilar')}
      ${ddFilter('serie','Serie',allSeries,AF.serie,'serie')}
      ${hasF?`<button class="clear-all-btn" onclick="clearF()">‚úï Limpiar filtros</button>`:''}
      <div style="margin-left:auto;display:flex;align-items:center;gap:6px;"><span class="flabel">Ordenar:</span><select class="dd-trigger" style="cursor:pointer;border-radius:8px" onchange="setSort(this.value)"><option value="default" ${sortBy==='default'?'selected':''}>Por defecto</option><option value="date_asc" ${sortBy==='date_asc'?'selected':''}>Fecha ‚Üë</option><option value="date_desc" ${sortBy==='date_desc'?'selected':''}>Fecha ‚Üì</option></select></div>
    </div>
    <div class="board">
      ${Object.keys(STATUS).map(sk=>renderCol(sk,vis)).join('')}
    </div>`;

  initDrag();
  initDropdowns();
}

function ddFilter(id, label, options, active, type) {
  const count = active.length;
  return `<div class="dd-wrap" id="ddwrap-${id}">
    <button class="dd-trigger${count?' active':''}" onclick="toggleDD('${id}')">
      ${label} ${count?`<span class="active-count">${count}</span>`:''}
      <span class="arrow">‚ñæ</span>
    </button>
    <div class="dd-menu" id="dd-${id}">
      ${options.map(o=>`<div class="dd-item${active.includes(o)?' checked':''}" onclick="tF('${type}','${eA(o)}')">
        <div class="check">${active.includes(o)?'‚úì':''}</div>${o}
      </div>`).join('')}
      ${count?`<div class="dd-divider"></div><div class="dd-clear" onclick="clearType('${type}')">Limpiar</div>`:''}
    </div>
  </div>`;
}

function renderCol(sk, vis) {
  const sm = STATUS[sk];
  const col = vis.filter(c=>c.status===sk);
  const total = cards.filter(c=>c.status===sk).length;
  return `<div class="col">
    <div class="col-header">
      <span class="col-badge ${sm.cls}">${sm.label}</span>
      <span class="col-count">${total}</span>
      <button class="col-addbtn" onclick="openDetail(null,'${sk}')">+</button>
    </div>
    <div class="cards" data-col="${sk}">${col.map(renderCard).join('')}</div>
    <button class="add-card-btn" onclick="openDetail(null,'${sk}')"><span style="font-size:15px">+</span> New item</button>
  </div>`;
}

function renderCard(c) {
  const chTags   = (c.channels||[]).map(p=>`<span class="tag t-plat">${PLAT_ICONS[p]||''} ${p}</span>`).join('');
  const pilarTags= (c.pilar||[]).map(p=>`<span class="tag ${PILAR_TAG_CLS[p]||''}">${p}</span>`).join('');
  const serieTags= (c.serie||[]).map(s=>`<span class="tag ${SERIE_TAG_CLS[s]||''}">${s}</span>`).join('');
  const icpTags  = (c.icp||[]).map(i=>`<span class="tag t-icp">ICP: ${i}</span>`).join('');
  const whoTags  = (c.who||[]).map(w=>`<span class="tag t-who">${w}</span>`).join('');
  const ptTags   = (c.postType||[]).map(pt=>`<span class="tag t-posttype">${pt}</span>`).join('');
  const allTags  = [chTags,ptTags,pilarTags,serieTags,whoTags,icpTags].filter(Boolean).join('');
  const footer   = c.date?`<div class="card-footer"><span class="cmeta">üìÖ ${fmt(c.date)}</span></div>`:'';
  return `<div class="card" draggable="true" data-id="${c.id}" onclick="openDetail('${c.id}')">
    <div class="card-top">
      <span class="card-grab">‚†ø</span>
      <span class="card-title-text">${eH(c.title)}</span>
    </div>
    ${allTags?`<div class="card-tags">${allTags}</div>`:''}
    ${footer}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDrag() {
  document.querySelectorAll('.card[draggable]').forEach(card=>{
    card.addEventListener('dragstart',e=>{dragId=card.dataset.id;card.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    card.addEventListener('dragend',()=>{card.classList.remove('dragging');document.querySelectorAll('.cards').forEach(c=>c.classList.remove('drag-over'));});
  });
  document.querySelectorAll('.cards[data-col]').forEach(zone=>{
    zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over');});
    zone.addEventListener('dragleave',e=>{if(!zone.contains(e.relatedTarget))zone.classList.remove('drag-over');});
    zone.addEventListener('drop',e=>{
      e.preventDefault();zone.classList.remove('drag-over');
      const ts=zone.dataset.col; if(!dragId||!ts) return;
      const card=cards.find(c=>c.id===dragId);
      if(card&&card.status!==ts){card.status=ts;qSave();render();toast(`Movido a ${STATUS[ts].label}`);}
      dragId=null;
    });
  });
}

// ‚îÄ‚îÄ‚îÄ DROPDOWN FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDropdowns() {
  document.addEventListener('click', e => {
    if (!e.target.closest('.dd-wrap')) closeAllDD();
  }, {once:true});
}
function toggleDD(id) {
  const menu = document.getElementById('dd-'+id);
  const isOpen = menu.classList.contains('open');
  closeAllDD();
  if(!isOpen) {menu.classList.add('open'); openDropdown=id;}
}
function closeAllDD() {
  document.querySelectorAll('.dd-menu.open').forEach(m=>m.classList.remove('open'));
  openDropdown=null;
}
document.addEventListener('click', e=>{if(!e.target.closest('.dd-wrap'))closeAllDD();});

// ‚îÄ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let detailCard = null;

function openDetail(id, presetStatus) {
  if(dragId) return;
  closeAllDD();
  if(id) {
    detailCard = JSON.parse(JSON.stringify(cards.find(c=>c.id===id)));
  } else {
    detailCard = {
      id:'c'+Date.now().toString(36), title:'', status:presetStatus||'backlog',
      channels:[], postType:[], who:[], pilar:[], serie:[], icp:[],
      date:'', brief:'', slides:[], refs:[], copyOut:'', notes:'', url:'', createdAt:Date.now()
    };
  }
  currentDetailId = id;
  renderDetail();
  document.getElementById('detailOverlay').classList.remove('hidden');
}

function renderDetail() {
  const c = detailCard;
  const overlay = document.getElementById('detailOverlay');
  const statusMeta = STATUS[c.status]||STATUS.backlog;
  const availSeries = c.pilar.length ? (PILAR_SERIES[c.pilar[0]]||[]) : [];

  overlay.innerHTML = `<div class="detail-panel">
    <button class="detail-close" onclick="closeDetail()">‚úï</button>

    <div class="detail-icon-area">üìã</div>
    <div class="detail-title-area">
      <input class="detail-title" value="${eA(c.title)}" placeholder="T√≠tulo del contenido..." oninput="detailCard.title=this.value">
    </div>

    <div class="detail-props">
      <!-- Status -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">‚äû</span> Status</div>
        <div class="prop-value" onclick="toggleIProp(event,'status')">
          <span class="tag ${statusMeta.cls}">${statusMeta.label}</span>
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-status">
              ${Object.entries(STATUS).map(([k,v])=>`<div class="ip-item${c.status===k?' on':''}" onclick="setProp('status','${k}');event.stopPropagation()">
                <div class="ip-check">${c.status===k?'‚úì':''}</div>
                <span class="tag ${v.cls}">${v.label}</span>
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- Channel -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üì°</span> Canal</div>
        <div class="prop-value${!c.channels.length?' empty':''}" onclick="toggleIProp(event,'channels')">
          ${c.channels.length ? c.channels.map(ch=>`<span class="tag t-channel">${PLAT_ICONS[ch]||''} ${ch}</span>`).join('') : 'Vac√≠o'}
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-channels">
              ${CHANNELS.map(ch=>`<div class="ip-item${c.channels.includes(ch)?' on':''}" onclick="togglePropArr('channels','${ch}');event.stopPropagation()">
                <div class="ip-check">${c.channels.includes(ch)?'‚úì':''}</div>${PLAT_ICONS[ch]||''} ${ch}
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- Post Type -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üé¨</span> Post Type</div>
        <div class="prop-value${!c.postType.length?' empty':''}" onclick="toggleIProp(event,'postType')">
          ${c.postType.length ? c.postType.map(pt=>`<span class="tag t-posttype">${pt}</span>`).join('') : 'Vac√≠o'}
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-postType">
              ${POST_TYPES.map(pt=>`<div class="ip-item${(c.postType||[]).includes(pt)?' on':''}" onclick="togglePropArr('postType','${pt}');event.stopPropagation()">
                <div class="ip-check">${(c.postType||[]).includes(pt)?'‚úì':''}</div>${pt}
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- Publish Date -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üìÖ</span> Publish Date</div>
        <div class="prop-value">
          <input type="date" style="border:none;outline:none;font-family:inherit;font-size:.84rem;color:var(--text);background:transparent;cursor:pointer" value="${c.date||''}" onchange="detailCard.date=this.value">
        </div>
      </div>
      <!-- Who produces -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üë§</span> Who produces</div>
        <div class="prop-value${!c.who.length?' empty':''}" onclick="toggleIProp(event,'who')">
          ${c.who.length ? c.who.map(w=>`<span class="tag t-who">${w}</span>`).join('') : 'Vac√≠o'}
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-who">
              ${WHO_LIST.map(w=>`<div class="ip-item${c.who.includes(w)?' on':''}" onclick="togglePropArr('who','${w}');event.stopPropagation()">
                <div class="ip-check">${c.who.includes(w)?'‚úì':''}</div>${w}
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- Pilar -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üèõ</span> Pilar</div>
        <div class="prop-value${!c.pilar.length?' empty':''}" onclick="toggleIProp(event,'pilar')">
          ${c.pilar.length ? c.pilar.map(p=>`<span class="tag ${PILAR_TAG_CLS[p]||''}">${p}</span>`).join('') : 'Vac√≠o'}
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-pilar">
              ${PILAR_LIST.map(p=>`<div class="ip-item${c.pilar.includes(p)?' on':''}" onclick="setPilar('${eA(p)}');event.stopPropagation()">
                <div class="ip-check">${c.pilar.includes(p)?'‚úì':''}</div>
                <span class="tag ${PILAR_TAG_CLS[p]||''}">${p}</span>
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- Serie -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üìö</span> Serie</div>
        <div class="prop-value${!c.serie.length?' empty':''}" onclick="${availSeries.length?`toggleIProp(event,'serie')`:'void(0)'}">
          ${c.serie.length ? c.serie.map(s=>`<span class="tag ${SERIE_TAG_CLS[s]||''}">${s}</span>`).join('') : (c.pilar.length?'Vac√≠o':'Selecciona Pilar primero')}
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-serie">
              ${availSeries.map(s=>`<div class="ip-item${c.serie.includes(s)?' on':''}" onclick="togglePropArr('serie','${eA(s)}');event.stopPropagation()">
                <div class="ip-check">${c.serie.includes(s)?'‚úì':''}</div>
                <span class="tag ${SERIE_TAG_CLS[s]||''}">${s}</span>
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- ICP -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üéØ</span> Target Audience</div>
        <div class="prop-value${!c.icp.length?' empty':''}" onclick="toggleIProp(event,'icp')">
          ${c.icp.length ? c.icp.map(i=>`<span class="tag t-icp">${i}</span>`).join('') : 'Vac√≠o'}
          <div class="prop-select-wrap">
            <div class="inline-picker hidden" id="ip-icp">
              ${ICP_LIST.map(i=>`<div class="ip-item${c.icp.includes(i)?' on':''}" onclick="togglePropArr('icp','${i}');event.stopPropagation()">
                <div class="ip-check">${c.icp.includes(i)?'‚úì':''}</div>${i}
              </div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <!-- Media Link -->
      <div class="prop-row">
        <div class="prop-label"><span class="prop-label-icon">üîó</span> Media Link</div>
        <div class="prop-value">
          <input type="url" style="border:none;outline:none;font-family:inherit;font-size:.84rem;color:var(--accent);background:transparent;width:100%" placeholder="https://..." value="${eA(c.url||'')}" oninput="detailCard.url=this.value">
        </div>
      </div>
    </div>

    <div class="detail-body">
      <!-- BRIEF -->
      <div class="section-block">
        <div class="section-heading">üìù Brief / Notas para producci√≥n</div>
        <div class="rich-toolbar">
          <button class="rich-btn" onclick="rf('bold')" title="Negrita"><b>B</b></button>
          <button class="rich-btn" onclick="rf('italic')" title="Cursiva"><i>I</i></button>
          <button class="rich-btn" onclick="rf('underline')" title="Subrayado"><u>U</u></button>
          <div class="rich-sep"></div>
          <button class="rich-btn" onclick="rf('insertUnorderedList')" title="Lista">‚Ä¢ Lista</button>
          <button class="rich-btn" onclick="rf('insertOrderedList')" title="Numerada">1. Numerada</button>
          <div class="rich-sep"></div>
          <button class="rich-btn" onclick="insertTable()" title="Tabla">‚äû Tabla</button>
          <button class="rich-btn" onclick="insertLink()" title="Link">üîó Link</button>
          <div class="rich-sep"></div>
          <button class="rich-btn" onclick="rf('removeFormat')" title="Limpiar formato">‚úï Formato</button>
        </div>
        <div class="rich-editor" id="briefEditor" contenteditable="true" data-placeholder="Instrucciones, contexto, referencias textuales para la agencia‚Ä¶" oninput="detailCard.brief=this.innerHTML">${linkify(c.brief||'')}</div>
      </div>

      <!-- SLIDES -->
      <div class="section-block">
        <div class="section-heading">üóÇ Slides</div>
        <div class="slides-list" id="slidesList">
          ${(c.slides||[]).map((s,i)=>slideHTML(s,i)).join('')}
        </div>
        <button class="add-slide-btn" onclick="addSlide()">+ Agregar slide</button>
      </div>

      <!-- COPY OUT -->
      <div class="section-block">
        <div class="section-heading">‚úçÔ∏è Copy out</div>
        <textarea class="section-textarea" placeholder="Caption, copy para el post‚Ä¶" oninput="detailCard.copyOut=this.value">${eH(c.copyOut||'')}</textarea>
      </div>

      <!-- IMAGE REFS -->
      <div class="section-block">
        <div class="section-heading">üñº Referencias de imagen</div>
        <div class="img-refs" id="imgRefs">
          ${(c.refs||[]).map((r,i)=>imgRefHTML(r,i)).join('')}
          <div class="img-upload-btn" onclick="triggerImgUpload()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Subir imagen
          </div>
        </div>
      </div>
    </div>

    <div class="detail-footer">
      ${currentDetailId?`<button class="btn btn-del" onclick="deleteCard()">Eliminar</button>`:''}
      <button class="btn btn-ghost" onclick="closeDetail()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveDetail()">Guardar</button>
    </div>
  </div>`;

  // Close inline pickers on outside click + auto-expand textareas
  setTimeout(()=>{
    overlay.addEventListener('click', e=>{
      if(!e.target.closest('.prop-value')) closeAllPickers();
    });
    document.querySelectorAll('.section-textarea').forEach(ta=>{
      // expand to fit existing content
      ta.style.height='auto';
      ta.style.height=ta.scrollHeight+'px';
      // expand on typing
      ta.addEventListener('input',function(){
        this.style.height='auto';
        this.style.height=this.scrollHeight+'px';
      });
    });
  },50);
}

function slideHTML(s,i){
  return `<div class="slide-item" id="slide-${i}">
    <div class="slide-header">
      <span class="slide-num">Slide ${i+1}</span>
      <button class="slide-del" onclick="removeSlide(${i})">‚úï</button>
    </div>
    <input class="slide-input" placeholder="T√≠tulo del slide‚Ä¶" value="${eA(s.title||'')}" oninput="detailCard.slides[${i}].title=this.value">
    <textarea class="slide-body" placeholder="Cuerpo / bullet points‚Ä¶" oninput="detailCard.slides[${i}].body=this.value">${eH(s.body||'')}</textarea>
  </div>`;
}

function imgRefHTML(r,i){
  return `<div class="img-ref-item">
    <img src="${r}" alt="ref">
    <button class="img-ref-del" onclick="removeRef(${i})">‚úï</button>
  </div>`;
}

function addSlide(){
  detailCard.slides.push({title:'',body:''});
  const list=document.getElementById('slidesList');
  const i=detailCard.slides.length-1;
  list.insertAdjacentHTML('beforeend',slideHTML({title:'',body:''},i));
}
function removeSlide(i){
  detailCard.slides.splice(i,1);
  renderDetail();
}
function removeRef(i){
  detailCard.refs.splice(i,1);
  renderDetail();
}
function triggerImgUpload(){document.getElementById('imgFileInput').click();}
function handleImgUpload(e){
  const files=[...e.target.files];
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{
      detailCard.refs.push(ev.target.result);
      const refs=document.getElementById('imgRefs');
      const uploadBtn=refs.querySelector('.img-upload-btn');
      uploadBtn.insertAdjacentHTML('beforebegin',imgRefHTML(ev.target.result,detailCard.refs.length-1));
    };
    r.readAsDataURL(f);
  });
  e.target.value='';
}

// Inline prop pickers
let openPicker = null;
function toggleIProp(e, prop){
  e.stopPropagation();
  const picker = document.getElementById('ip-'+prop);
  if(!picker) return;
  const isOpen = !picker.classList.contains('hidden');
  closeAllPickers();
  if(!isOpen){picker.classList.remove('hidden');openPicker=prop;}
}
function closeAllPickers(){
  document.querySelectorAll('.inline-picker').forEach(p=>p.classList.add('hidden'));
  openPicker=null;
}
function setProp(prop, val){
  detailCard[prop]=val;
  closeAllPickers();
  renderDetail();
}
function togglePropArr(prop, val){
  const arr=detailCard[prop]||[];
  detailCard[prop]=arr.includes(val)?arr.filter(x=>x!==val):[...arr,val];
  renderDetail();
  // Reopen the picker
  setTimeout(()=>{
    const picker=document.getElementById('ip-'+prop);
    if(picker) picker.classList.remove('hidden');
  },10);
}
function setPilar(val){
  detailCard.pilar=[val];
  detailCard.serie=[];
  closeAllPickers();
  renderDetail();
  setTimeout(()=>{const p=document.getElementById('ip-pilar');if(p)p.classList.remove('hidden');},10);
}

function saveDetail(){
  const title=detailCard.title.trim();
  if(!title){document.querySelector('.detail-title').focus();return;}
  // Collect any textarea values that may not have fired oninput
  const briefEl=document.getElementById('briefEditor');
  if(briefEl) detailCard.brief=briefEl.innerHTML;
  const copyTA=document.querySelectorAll('.section-textarea')[1];
  if(copyTA) detailCard.copyOut=copyTA.value;
  // Collect slides
  document.querySelectorAll('.slide-item').forEach((el,i)=>{
    if(detailCard.slides[i]){
      detailCard.slides[i].title=el.querySelector('.slide-input').value;
      detailCard.slides[i].body=el.querySelector('.slide-body').value;
    }
  });

  if(currentDetailId){const idx=cards.findIndex(c=>c.id===currentDetailId);cards[idx]=detailCard;}
  else cards.unshift(detailCard);
  qSave(); closeDetail(); render();
  toast(currentDetailId?'‚úì Actualizado':'‚úì Creado');
}

function deleteCard(){
  if(!currentDetailId||!confirm('¬øEliminar?')) return;
  cards=cards.filter(c=>c.id!==currentDetailId);
  qSave(); closeDetail(); render(); toast('Eliminado');
}

// Rich editor helpers
function linkify(text){
  if(!text) return '';
  // If it's already HTML (from rich editor), return as-is
  if(text.trim().startsWith('<')) return text;
  // Otherwise convert plain text: auto-link URLs
  const escaped = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return escaped.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>').replace(/\n/g,'<br>');
}
function rf(cmd,val){document.getElementById('briefEditor')?.focus();document.execCommand(cmd,false,val||null);}
function insertTable(){
  const rows=parseInt(prompt('¬øCu√°ntas filas?','3')||'3');
  const cols=parseInt(prompt('¬øCu√°ntas columnas?','2')||'2');
  if(!rows||!cols) return;
  let html='<table>';
  html+='<tr>'+Array(cols).fill(0).map((_,i)=>`<th>Columna ${i+1}</th>`).join('')+'</tr>';
  for(let r=0;r<rows-1;r++) html+='<tr>'+Array(cols).fill('<td>&nbsp;</td>').join('')+'</tr>';
  html+='</table><p><br></p>';
  document.getElementById('briefEditor')?.focus();
  document.execCommand('insertHTML',false,html);
  detailCard.brief=document.getElementById('briefEditor').innerHTML;
}
function insertLink(){
  const url=prompt('URL del link:','https://');
  if(!url||url==='https://') return;
  const text=prompt('Texto del link (opcional, Enter para usar la URL):','')||url;
  document.getElementById('briefEditor')?.focus();
  document.execCommand('insertHTML',false,`<a href="${url}" target="_blank" rel="noopener">${text}</a>`);
  detailCard.brief=document.getElementById('briefEditor').innerHTML;
}

function closeDetail(){
  document.getElementById('detailOverlay').classList.add('hidden');
  currentDetailId=null; detailCard=null;
}
function detailBgClose(e){if(e.target.id==='detailOverlay')closeDetail();}

// ‚îÄ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openImport(){document.getElementById('importOverlay').classList.remove('hidden');}
function closeImport(){document.getElementById('importOverlay').classList.add('hidden');pendingImport=[];}
function importBgClose(e){if(e.target.id==='importOverlay')closeImport();}

function handleCSV(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const text=ev.target.result;
    const rows=parseCSV(text);
    if(!rows.length){document.getElementById('importPreview').textContent='No se encontraron datos.';return;}
    const headers=Object.keys(rows[0]);
    pendingImport=rows.map(row=>{
      // Map common Notion field names to our schema
      const get=(...keys)=>{for(const k of keys){if(row[k]!==undefined&&row[k]!=='')return row[k];}return '';};
      const getArr=(...keys)=>{const v=get(...keys);return v?v.split(',').map(x=>x.trim()).filter(Boolean):[];};
      const statusMap={'Backlog':'backlog','Prioritize':'prioritize','üî• Prioritize':'prioritize','Design feedback':'designfb','Design Feedback':'designfb','Scheduled':'scheduled','Published':'published','Archived':'archived'};
      const rawStatus=get('Status','status','Estado');
      return {
        id:'imp'+Date.now().toString(36)+Math.random().toString(36).slice(2,5),
        title:get('Name','Title','T√≠tulo','title','name')||'Sin t√≠tulo',
        status:statusMap[rawStatus]||'backlog',
        channels:getArr('Channel','Channels','Canal','Platform','Platforms'),
        postType:getArr('Post Type','PostType','Tipo'),
        who:getArr('Who produces','Who Produces','Qui√©n produce'),
        pilar:getArr('Pilar','Pillar'),
        serie:getArr('Serie','Series'),
        icp:getArr('Target Audience','ICP','Audience'),
        date:get('Publish Date','Date','Fecha','publish_date')||'',
        brief:get('Reference','Brief','Notes','Notas')||'',
        slides:[],refs:[],copyOut:'',notes:'',url:get('Media Link','URL','url')||'',
        createdAt:Date.now(),
      };
    });
    const prev=document.getElementById('importPreview');
    prev.classList.remove('hidden');
    prev.innerHTML=`<strong>${pendingImport.length} piezas encontradas</strong> ‚Äî se agregar√°n al tablero sin borrar las existentes.<br><span style="color:var(--text3);font-size:.78rem">Columnas detectadas: ${headers.join(', ')}</span>`;
    document.getElementById('btnImportConfirm').classList.remove('hidden');
  };
  reader.readAsText(file);
}

function confirmImport(){
  cards=[...cards,...pendingImport];
  qSave(); closeImport(); render();
  toast(`‚úÖ ${pendingImport.length} piezas importadas`);
  pendingImport=[];
}

function exportCSV(){
  const headers = ['Publish Date','Post Title','Status','Channel','Pillar','Serie','Target Audience','Media Link','Reference','Materials to use','Who produces'];
  const statusLabel = {backlog:'Backlog',prioritize:'üî• Prioritize',designfb:'Design Feedback',scheduled:'Scheduled',published:'Published',archived:'Archived'};
  const whoLabel = {'Distrito':'Distrito MKT','SM Team':'SM team','Val':'Val','Creative Studio':'Creative Studio'};

  const rows = cards.map(c => [
    c.date||'',
    c.title||'',
    statusLabel[c.status]||c.status,
    (c.channels||[]).join(', '),
    (c.pilar||[]).join(', '),
    (c.serie||[]).join(', '),
    (c.icp||[]).join(', '),
    c.url||'',
    c.brief||'',
    c.notes||'',
    (c.who||[]).map(w=>whoLabel[w]||w).join(', '),
  ]);

  const escape = v => {
    const s = String(v||'');
    return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
  };

  const csv = [headers, ...rows].map(row => row.map(escape).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'Boosted_Content_Tracker.csv';
  a.click(); URL.revokeObjectURL(url);
  toast('üì§ CSV exportado ‚Äî ' + cards.length + ' piezas');
}

function parseCSV(text){
  const lines=text.split('\n').filter(l=>l.trim());
  if(lines.length<2) return [];
  const headers=lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
  return lines.slice(1).map(line=>{
    const vals=[];let cur='';let inQ=false;
    for(const ch of line){if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){vals.push(cur.trim());cur='';}else{cur+=ch;}}
    vals.push(cur.trim());
    const obj={};
    headers.forEach((h,i)=>obj[h]=(vals[i]||'').replace(/^"|"$/g,''));
    return obj;
  });
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setQ(v){searchQ=v;render();}
function tF(type,val){const a=AF[type];AF[type]=a.includes(val)?a.filter(x=>x!==val):[...a,val];render();}
function clearType(type){AF[type]=[];render();}
function clearF(){AF={channel:[],who:[],pilar:[],serie:[]};searchQ='';render();}
function eH(t){return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function eA(t){return String(t||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');}
function fmt(d){if(!d)return'';const dt=new Date(d+'T00:00:00');return dt.toLocaleDateString('es-MX',{day:'numeric',month:'short'});}
function toast(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>el.remove(),2400);}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeDetail();closeImport();}
  if((e.metaKey||e.ctrlKey)&&e.key==='Enter'&&detailCard)saveDetail();
});

(async()=>{
  await load(); render();
  // Sync from Sheets every 30s to pick up changes from other users
  setInterval(async()=>{
    if (Date.now() - lastSaveTime > 25000) {
      const prev = JSON.stringify(cards);
      await load();
      if(JSON.stringify(cards) !== prev) { render(); toast('üîÑ Tablero actualizado'); }
    }
  }, 30000);
})();
</script>
</body>
</html>
